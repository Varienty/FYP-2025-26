<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Admin: Add User Account</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button[type="submit"] {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
        }
        button[type="submit"]:hover {
            background-color: #0056b3;
        }
        #messageArea {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Add New User Account</h1>
        
        <form id="addUserForm">
            <label for="userRole">Account Role:</label>
            <select id="userRole" name="userRole" required>
                <option value="Lecturer">Lecturer</option>
                <option value="StudentServiceAdmin">Student Service Administrator</option>
                <option value="SystemAdministrator">System Administrator</option>
            </select>
            
            <label for="userID">User ID (e.g., L987654):</label>
            <input type="text" id="userID" name="userID" required>
            
            <label for="name">Full Name:</label>
            <input type="text" id="name" name="name" required>
            
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
            
            <label for="initialPassword">Initial Password:</label>
            <input type="password" id="initialPassword" name="initialPassword" required>
            
            <button type="submit">Create Account</button>
        </form>
        
        <p id="messageArea"></p>
    </div>

    <script src="../../common/config.js"></script>
    <script src="../../common/auth.js"></script>
    <script>
        requireAuth('system-admin');
        document.getElementById('addUserForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Stop the default form submission

            const form = event.target;
            const messageArea = document.getElementById('messageArea');

            // 1. BOUNDARY: Gather all the input data from the form
            const newUserData = {
                // Changed userType to userRole to reflect the selection field ID
                userRole: form.userRole.value, 
                userID: form.userID.value,
                name: form.name.value,
                email: form.email.value,
                password: form.initialPassword.value 
            };

            // 2. BOUNDARY: Perform basic client-side validation
            if (newUserData.userID.trim() === "" || newUserData.password.length < 8) {
                messageArea.style.backgroundColor = '#ffe0e0';
                messageArea.style.color = '#cc0000';
                messageArea.textContent = "Please ensure all fields are filled and password is at least 8 characters.";
                return;
            }

            // Clear previous messages
            messageArea.textContent = "Processing...";
            messageArea.style.backgroundColor = '#e0f7fa';
            messageArea.style.color = '#0056b3';


            // 3. BOUNDARY: Send the data to the server-side Controller via an API call
            // NOTE: The URL '/api/users' must match the backend controller's endpoint.
            const apiBase = window.API_ENDPOINTS?.['system-admin'] || 'http://localhost:5009';
            fetch(apiBase + '/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + sessionStorage.getItem('auth_user')
                },
                body: JSON.stringify(newUserData),
            })
            .then(response => {
                if (response.ok) {
                    // Success response from the Controller
                    messageArea.style.backgroundColor = '#e6ffe6';
                    messageArea.style.color = '#008000';
                    messageArea.textContent = '✅ Account created successfully!';
                    form.reset(); // Clear the form
                } else if (response.status === 409) {
                    // Example status code for 'Conflict' (e.g., User ID already exists)
                    return response.json().then(data => {
                        throw new Error(data.message || "User ID already exists.");
                    });
                } else {
                    // Other error/failure response from the Controller
                    return response.json().then(data => {
                        throw new Error(data.message || "Account creation failed due to server error.");
                    });
                }
            })
            .catch(error => {
                // Handle network errors or specific errors thrown above
                messageArea.style.backgroundColor = '#ffe0e0';
                messageArea.style.color = '#cc0000';
                messageArea.textContent = `❌ Error: ${error.message}`;
            });
        });
    </script>
</body>
</html>