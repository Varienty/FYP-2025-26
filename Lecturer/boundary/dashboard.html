<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturer Dashboard | Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/config.js"></script>
    <script src="/static/auth.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-6">
                    <a href="dashboard.html" class="text-lg font-semibold border-b-2 border-white">Dashboard</a>
                    <a href="real_time_list.html" class="text-lg font-semibold hover:text-blue-200 transition">Real-Time</a>
                    <a href="attendance_records.html" class="text-lg font-semibold hover:text-blue-200 transition">Attendance Records</a>
                    <a href="class_schedule.html" class="text-lg font-semibold hover:text-blue-200 transition">Class Schedule</a>
                    <a href="attendance_report.html" class="text-lg font-semibold hover:text-blue-200 transition">Attendance Report</a>
                    <a href="notifications.html" class="text-lg font-semibold hover:text-blue-200 transition">Notifications</a>
                </div>
                <button data-action="logout" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-white shadow">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Lecturer Dashboard</h1>
                    <p class="text-sm text-gray-600">Welcome, <span id="userName">Lecturer</span></p>
                </div>
                <div class="relative">
                    <button id="notificationBell" class="relative hover:bg-gray-100 p-2 rounded-lg transition">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span id="notificationBadge" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Notification Alert Area (US17 - Sequence Diagram #17) -->
        <div id="notificationArea" class="mb-6 hidden">
            <div id="notificationCard" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="flex-1">
                        <p id="notificationMessage" class="font-semibold text-gray-800"></p>
                        <p id="notificationTime" class="text-sm text-gray-600"></p>
                    </div>
                    <button id="closeNotification" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Classes</p>
                        <p id="totalClasses" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Today's Classes</p>
                        <p id="todayClasses" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Avg Attendance</p>
                        <p id="avgAttendance" class="text-3xl font-bold text-gray-800">0%</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Active Sessions</p>
                        <p id="activeSessions" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Navigation Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Real-Time List (US14) -->
            <a href="./real_time_list.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition group">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-100 p-3 rounded-lg group-hover:scale-110 transition">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </div>
                    <h3 class="ml-4 text-lg font-semibold text-gray-800">Real-Time</h3>
                </div>
                <p class="text-gray-600 text-sm">Monitor students detected by face recognition during lecture sessions.</p>
                <span class="inline-block mt-4 text-blue-600 text-sm font-semibold group-hover:underline">Open →</span>
            </a>

            <!-- Attendance Records (US18) -->
            <a href="./attendance_records.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition group">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 p-3 rounded-lg group-hover:scale-110 transition">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                    </div>
                    <h3 class="ml-4 text-lg font-semibold text-gray-800">Attendance Records</h3>
                </div>
                <p class="text-gray-600 text-sm">Filter and search attendance records by date, student, or status.</p>
                <span class="inline-block mt-4 text-red-600 text-sm font-semibold group-hover:underline">Search →</span>
            </a>

            <!-- Class Schedule (US16) -->
            <a href="./class_schedule.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition group">
                <div class="flex items-center mb-4">
                    <div class="bg-purple-100 p-3 rounded-lg group-hover:scale-110 transition">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 class="ml-4 text-lg font-semibold text-gray-800">Class Schedule</h3>
                </div>
                <p class="text-gray-600 text-sm">View your weekly class schedule with dates, times, and locations.</p>
                <span class="inline-block mt-4 text-purple-600 text-sm font-semibold group-hover:underline">View →</span>
            </a>

            <!-- Attendance Report (US15) -->
            <a href="./attendance_report.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition group">
                <div class="flex items-center mb-4">
                    <div class="bg-green-100 p-3 rounded-lg group-hover:scale-110 transition">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h3 class="ml-4 text-lg font-semibold text-gray-800">Attendance Report</h3>
                </div>
                <p class="text-gray-600 text-sm">Generate and download attendance reports with statistics and trends.</p>
                <span class="inline-block mt-4 text-green-600 text-sm font-semibold group-hover:underline">Generate →</span>
            </a>

            <!-- Notifications (US17) -->
            <a href="./notifications.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition group">
                <div class="flex items-center mb-4">
                    <div class="bg-yellow-100 p-3 rounded-lg group-hover:scale-110 transition">
                        <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </div>
                    <h3 class="ml-4 text-lg font-semibold text-gray-800">Notifications</h3>
                </div>
                <p class="text-gray-600 text-sm">View attendance session notifications and system alerts.</p>
                <span class="inline-block mt-4 text-yellow-600 text-sm font-semibold group-hover:underline">View All →</span>
            </a>

        </div>
    </main>

    <script>
        // Show message helper
        function showMessage(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } text-white`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Auth check
        requireAuth('lecturer');

        // Load dashboard data from database
        async function loadDashboardData() {
            const authUser = sessionStorage.getItem('auth_user');
            if (!authUser) {
                showMessage('No user found. Please log in.', 'error');
                return;
            }

            const user = JSON.parse(authUser);
            const lecturerId = user.lecturer_id || user.lecturerId;
            
            if (!lecturerId) {
                showMessage('No lecturer ID found', 'error');
                return;
            }

            try {
                // Dashboard stats are on port 5004 (lecturer-attendance)
                const API_BASE = window.API_ENDPOINTS?.['lecturer-attendance'] || 'http://localhost:5004';
                const response = await fetch(`${API_BASE}/api/lecturer/dashboard/stats?lecturerId=${lecturerId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.stats) {
                        document.getElementById('totalClasses').textContent = result.stats.totalClasses;
                        document.getElementById('todayClasses').textContent = result.stats.todayClasses;
                        document.getElementById('avgAttendance').textContent = result.stats.avgAttendance + '%';
                        document.getElementById('activeSessions').textContent = result.stats.activeSessions;
                        
                        // Update user name in header
                        document.getElementById('userName').textContent = user.first_name || user.email;
                        return;
                    }
                }
                
                throw new Error('Failed to load stats');
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showMessage('Error loading dashboard data', 'error');
                // Set default values on error
                document.getElementById('totalClasses').textContent = '0';
                document.getElementById('todayClasses').textContent = '0';
                document.getElementById('avgAttendance').textContent = '0%';
                document.getElementById('activeSessions').textContent = '0';
            }
        }

        // US17 - Subscribe to notifications (Sequence Diagram #17)
        async function subscribeNotifications() {
            const authUser = sessionStorage.getItem('auth_user');
            if (!authUser) return;

            const user = JSON.parse(authUser);
            const lecturerId = user.lecturer_id || user.lecturerId;

            try {
                // Notifications are on port 5007 (lecturer-notifications)
                const API_BASE = window.API_ENDPOINTS?.['lecturer-notifications'] || 'http://localhost:5007';
                const response = await fetch(`${API_BASE}/api/lecturer/notification/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lecturerId: lecturerId,
                        email: user.email
                    })
                });

                if (response.ok) {
                    console.log('Successfully subscribed to notifications');
                }
            } catch (error) {
                console.error('Error subscribing to notifications:', error);
            }
        }

        // Display notification (US17)
        function showNotification(message, type) {
            const notificationArea = document.getElementById('notificationArea');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationTime = document.getElementById('notificationTime');
            const notificationCard = document.getElementById('notificationCard');
            const badge = document.getElementById('notificationBadge');

            // Update message
            notificationMessage.textContent = message;
            notificationTime.textContent = new Date().toLocaleTimeString();

            // Update card color based on type
            if (type === 'start') {
                notificationCard.className = 'bg-green-50 border-l-4 border-green-500 p-4 rounded-lg shadow';
            } else if (type === 'end') {
                notificationCard.className = 'bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow';
            } else {
                notificationCard.className = 'bg-red-50 border-l-4 border-red-500 p-4 rounded-lg shadow';
            }

            // Show notification
            notificationArea.classList.remove('hidden');

            // Update badge
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
            badge.classList.remove('hidden');

            // Note: Notifications are fetched from database in notifications.html
        }

        // Close notification
        document.getElementById('closeNotification').addEventListener('click', () => {
            document.getElementById('notificationArea').classList.add('hidden');
        });

        // Notification bell click
        document.getElementById('notificationBell').addEventListener('click', () => {
            window.location.href = './notifications.html';
        });

        // Generate class start notifications
        async function generateClassReminders() {
            try {
                const apiBase = window.API_ENDPOINTS?.['lecturer-notifications'] || 'http://localhost:5007';
                const response = await fetch(`${apiBase}/api/lecturer/notifications/generate-class-reminders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`[Dashboard] Generated ${data.count} class reminder(s)`);
                }
            } catch (error) {
                console.error('[Dashboard] Error generating class reminders:', error);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Generate class reminders
            generateClassReminders();

            // Load dashboard data
            loadDashboardData();

            // Set up periodic check every 5 minutes
            setInterval(generateClassReminders, 5 * 60 * 1000);

            // subscribeNotifications(); // Disabled - not needed for basic notifications
        });
    </script>
</body>
</html>
