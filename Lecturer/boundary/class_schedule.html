<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Schedule | Lecturer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../common/config.js"></script>
    <script src="../../common/auth.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-6">
                    <a href="dashboard.html" class="text-lg font-semibold hover:text-blue-200 transition">Dashboard</a>
                    <a href="real_time_list.html" class="text-lg font-semibold hover:text-blue-200 transition">Real-Time</a>
                    <a href="attendance_records.html" class="text-lg font-semibold hover:text-blue-200 transition">Attendance Records</a>
                    <a href="class_schedule.html" class="text-lg font-semibold border-b-2 border-white">Class Schedule</a>
                    <a href="attendance_report.html" class="text-lg font-semibold hover:text-blue-200 transition">Attendance Report</a>
                    <a href="notifications.html" class="text-lg font-semibold hover:text-blue-200 transition">Notifications</a>
                </div>
                <button data-action="logout" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-white shadow">
        <div class="container mx-auto px-6 py-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Class Schedule</h1>
                <p class="text-sm text-gray-600">View your monthly timetable</p>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Calendar -->
        <div class="bg-white rounded-lg shadow">
            <!-- Calendar Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800" id="monthYear">December 2025</h2>
                    <div class="flex items-center gap-2">
                        <button id="prevMonth" class="p-2 hover:bg-gray-100 rounded-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <button id="todayBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                            Today
                        </button>
                        <button id="nextMonth" class="p-2 hover:bg-gray-100 rounded-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="p-6">
                <!-- Day Headers -->
                <div class="grid grid-cols-7 gap-2 mb-2">
                    <div class="text-center font-semibold text-gray-600 py-2">Mon</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Tue</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Wed</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Thu</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Fri</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Sat</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Sun</div>
                </div>

                <!-- Calendar Days -->
                <div id="calendarDays" class="grid grid-cols-7 gap-2">
                    <!-- Days will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Class Details Modal -->
        <div id="classModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800" id="modalDate">Classes for Date</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalContent" class="p-6">
                    <!-- Class details will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        requireAuth('lecturer');

        let currentDate = new Date();
        let allClasses = [];

        // Color palette for different classes
        const classColors = [
            { bg: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-700' },
            { bg: 'bg-green-100', border: 'border-green-500', text: 'text-green-700' },
            { bg: 'bg-purple-100', border: 'border-purple-500', text: 'text-purple-700' },
            { bg: 'bg-orange-100', border: 'border-orange-500', text: 'text-orange-700' },
            { bg: 'bg-pink-100', border: 'border-pink-500', text: 'text-pink-700' },
            { bg: 'bg-indigo-100', border: 'border-indigo-500', text: 'text-indigo-700' },
        ];

        const classColorMap = {};

        function getClassColor(moduleId) {
            if (!classColorMap[moduleId]) {
                const colorIndex = Object.keys(classColorMap).length % classColors.length;
                classColorMap[moduleId] = classColors[colorIndex];
            }
            return classColorMap[moduleId];
        }

        // Load schedule from API
        async function loadSchedule() {
            try {
                const response = await fetch('http://127.0.0.1:5011/api/facial-recognition/timetable/all');

                if (!response.ok) {
                    throw new Error('Failed to load schedule');
                }

                const data = await response.json();

                if (data.ok && data.classes) {
                    allClasses = data.classes;
                    renderCalendar();
                } else {
                    console.error('No classes found');
                    renderCalendar();
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                showMessage('Failed to load schedule: ' + error.message, 'error');
                renderCalendar();
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month (0 = Sunday, 6 = Saturday) and adjust for Monday start
            const firstDay = new Date(year, month, 1).getDay();
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1; // Monday = 0

            // Get number of days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Get classes for this month
            const monthClasses = getClassesForMonth(year, month);

            // Clear calendar
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // Add empty cells for days before month starts
            for (let i = 0; i < adjustedFirstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.moduleName = 'min-h-[120px] bg-gray-50 rounded-lg';
                calendarDays.appendChild(emptyDay);
            }

            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayClasses = monthClasses[dateStr] || [];

                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();

                const dayCell = document.createElement('div');
                dayCell.moduleName = `min-h-[120px] border rounded-lg p-2 hover:bg-gray-50 transition cursor-pointer ${
                    isToday ? 'border-blue-500 border-2 bg-blue-50' : 'border-gray-200'
                }`;

                dayCell.innerHTML = `
                    <div class="font-semibold mb-2 ${isToday ? 'text-blue-600' : 'text-gray-700'}">${day}</div>
                    <div class="space-y-1">
                        ${dayClasses.slice(0, 3).map(cls => {
                            const color = getClassColor(cls.module_id);
                            return `
                                <div class="${color.bg} ${color.border} border-l-2 px-2 py-1 rounded text-xs">
                                    <div class="${color.text} font-medium truncate">${cls.module_code}</div>
                                    <div class="text-gray-600 text-[10px]">${cls.start_time}</div>
                                </div>
                            `;
                        }).join('')}
                        ${dayClasses.length > 3 ? `
                            <div class="text-xs text-gray-500 text-center">+${dayClasses.length - 3} more</div>
                        ` : ''}
                    </div>
                `;

                if (dayClasses.length > 0) {
                    dayCell.addEventListener('click', () => showDayDetails(dateStr, dayClasses));
                }

                calendarDays.appendChild(dayCell);
            }
        }

        function getClassesForMonth(year, month) {
            const monthClasses = {};

            allClasses.forEach(cls => {
                // Handle specific date classes
                if (cls.class_date) {
                    const classDate = new Date(cls.class_date);
                    if (classDate.getFullYear() === year && classDate.getMonth() === month) {
                        const dateStr = cls.class_date;
                        if (!monthClasses[dateStr]) monthClasses[dateStr] = [];
                        monthClasses[dateStr].push(cls);
                    }
                }
                // Handle recurring weekly classes
                else if (cls.day_of_week) {
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay(); // 1=Mon, 7=Sun

                        if (dayOfWeek === cls.day_of_week) {
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (!monthClasses[dateStr]) monthClasses[dateStr] = [];
                            monthClasses[dateStr].push(cls);
                        }
                    }
                }
            });

            // Sort classes by start time
            Object.keys(monthClasses).forEach(dateStr => {
                monthClasses[dateStr].sort((a, b) => a.start_time.localeCompare(b.start_time));
            });

            return monthClasses;
        }

        function showDayDetails(dateStr, classes) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('modalDate').textContent = date.toLocaleDateString('en-US', options);

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = classes.map(cls => {
                const color = getClassColor(cls.module_id);
                return `
                    <div class="mb-4 last:mb-0 border ${color.border} border-l-4 rounded-lg p-4 ${color.bg}">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <span class="font-bold ${color.text} text-lg">${cls.module_code}</span>
                                <span class="text-gray-700 ml-2">${cls.module_name}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${cls.start_time} - ${cls.end_time}
                            </div>
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                ${cls.room}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('classModal').classList.remove('hidden');
            document.getElementById('classModal').classList.add('flex');
        }

        function showMessage(message, type) {
            const notification = document.createElement('div');
            notification.moduleName = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Event listeners
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDate = new Date();
            renderCalendar();
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('classModal').classList.add('hidden');
            document.getElementById('classModal').classList.remove('flex');
        });

        // Close modal on background click
        document.getElementById('classModal').addEventListener('click', (e) => {
            if (e.target.id === 'classModal') {
                document.getElementById('classModal').classList.add('hidden');
                document.getElementById('classModal').classList.remove('flex');
            }
        });

        // Load schedule on page load
        document.addEventListener('DOMContentLoaded', loadSchedule);
    </script>
</body>
</html>
