<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Test Page</title>
    <script src="/common/config.js"></script>
    <script src="/common/auth.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        #logoutBtn { background: #f44336; }
        #logoutBtn:hover { background: #da190b; }
        .code { background: #f4f4f4; padding: 10px; border-left: 3px solid #4CAF50; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>FYP Attendance System - Debug Test Page</h1>
    
    <div class="test-section">
        <h2>1. Configuration Test</h2>
        <div id="configTest"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Auth.js Functions Test</h2>
        <div id="authTest"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Session Storage Test</h2>
        <div id="sessionTest"></div>
        <button onclick="testLogin()">Simulate Login</button>
        <button onclick="clearSession()">Clear Session</button>
    </div>
    
    <div class="test-section">
        <h2>4. Logout Button Test</h2>
        <button id="logoutBtn">Test Logout</button>
        <button data-action="logout">Test Logout (data-action)</button>
        <div id="logoutTest" style="margin-top: 10px;"></div>
    </div>
    
    <div class="test-section">
        <h2>5. API Endpoint Test</h2>
        <button onclick="testHealthEndpoint()">Test /health/db</button>
        <button onclick="testLoginEndpoint()">Test /api/auth/login</button>
        <button onclick="testLogoutEndpoint()">Test /api/auth/logout</button>
        <div id="apiTest" style="margin-top: 10px;"></div>
    </div>

    <div class="test-section">
        <h2>6. Database Connection & Data Test</h2>
        <button onclick="testDatabaseHealth()">Test Database Health</button>
        <button onclick="testAllEndpoints()">Test All Endpoints</button>
        <button onclick="testTableCounts()">Test Table Row Counts</button>
        
        <div id="dbHealthTest" style="margin-top: 10px;"></div>
        
        <p style="margin-top: 15px;"><strong>System Admin Endpoints:</strong></p>
        <button onclick="testPolicies()">Policies</button>
        <button onclick="testUsers()">Users</button>
        <button onclick="testAlerts()">Alerts</button>
        
        <p style="margin-top: 15px;"><strong>Student Service Admin Endpoints:</strong></p>
        <button onclick="testModules()">Modules</button>
        <button onclick="testLecturers()">Lecturers</button>
        <button onclick="testStudents()">Students</button>
        <button onclick="testTimetable()">Timetable</button>
        
        <p style="margin-top: 15px;"><strong>Attendance & Reports:</strong></p>
        <button onclick="testClasses()">Classes</button>
        <button onclick="testDailySummary()">Daily Summary</button>
        <button onclick="testLecturerReports()">Lecturer Reports</button>
        <button onclick="testLecturerAttendance()">Lecturer Attendance</button>
        
        <div id="dbTest" style="margin-top: 10px;"></div>
    </div>

    <script>
        // Test 1: Configuration
        function testConfig() {
            const output = document.getElementById('configTest');
            let html = '<div class="code">';
            html += `window.location.origin: ${window.location.origin}<br>`;
            html += `window.location.hostname: ${window.location.hostname}<br>`;
            html += `window.location.protocol: ${window.location.protocol}<br>`;
            html += `window.API_BASE: ${window.API_BASE}<br>`;
            html += `window.API_ENDPOINTS: ${JSON.stringify(window.API_ENDPOINTS, null, 2)}<br>`;
            html += '</div>';
            
            if (window.API_BASE && window.API_BASE !== 'http://localhost:5000') {
                html += '<p class="success">✓ Config loaded correctly for production</p>';
            } else if (window.location.hostname === 'localhost') {
                html += '<p class="success">✓ Config loaded correctly for localhost</p>';
            } else {
                html += '<p class="error">✗ Config might be using localhost fallback on production!</p>';
            }
            
            output.innerHTML = html;
        }
        
        // Test 2: Auth functions
        function testAuth() {
            const output = document.getElementById('authTest');
            let html = '';
            
            if (typeof window.logout === 'function') {
                html += '<p class="success">✓ logout() function is available</p>';
            } else {
                html += '<p class="error">✗ logout() function NOT found</p>';
            }
            
            if (typeof window.getCurrentUser === 'function') {
                html += '<p class="success">✓ getCurrentUser() function is available</p>';
            } else {
                html += '<p class="error">✗ getCurrentUser() function NOT found</p>';
            }
            
            if (typeof window.requireAuth === 'function') {
                html += '<p class="success">✓ requireAuth() function is available</p>';
            } else {
                html += '<p class="error">✗ requireAuth() function NOT found</p>';
            }
            
            output.innerHTML = html;
        }
        
        // Test 3: Session storage
        function testSession() {
            const output = document.getElementById('sessionTest');
            const authUser = sessionStorage.getItem('auth_user');
            const isAuth = sessionStorage.getItem('isAuthenticated');
            
            let html = '<div class="code">';
            html += `isAuthenticated: ${isAuth}<br>`;
            html += `auth_user: ${authUser || 'null'}<br>`;
            html += '</div>';
            
            if (isAuth === 'true' && authUser) {
                html += '<p class="success">✓ User is logged in</p>';
                try {
                    const user = JSON.parse(authUser);
                    html += `<p>Role: ${user.role}, Email: ${user.email || user.username}</p>`;
                } catch (e) {
                    html += '<p class="error">✗ Could not parse user data</p>';
                }
            } else {
                html += '<p class="error">✗ No active session</p>';
            }
            
            output.innerHTML = html;
        }
        
        function testLogin() {
            sessionStorage.setItem('isAuthenticated', 'true');
            sessionStorage.setItem('auth_user', JSON.stringify({
                email: 'test@example.com',
                role: 'system-admin',
                first_name: 'Test',
                last_name: 'User'
            }));
            testSession();
            document.getElementById('logoutTest').innerHTML = '<p class="success">Session created! Now try the logout buttons.</p>';
        }
        
        function clearSession() {
            sessionStorage.clear();
            testSession();
            document.getElementById('logoutTest').innerHTML = '<p>Session cleared manually.</p>';
        }
        
        // Test 4: Logout button
        document.getElementById('logoutBtn').addEventListener('click', function() {
            document.getElementById('logoutTest').innerHTML = '<p>Logout button clicked! Checking if logout() function executes...</p>';
            try {
                logout();
                document.getElementById('logoutTest').innerHTML += '<p class="success">✓ logout() executed</p>';
            } catch (e) {
                document.getElementById('logoutTest').innerHTML += `<p class="error">✗ Error: ${e.message}</p>`;
            }
        });
        
        // Test 5: API endpoints
        async function testHealthEndpoint() {
            const output = document.getElementById('apiTest');
            output.innerHTML = '<p>Testing /health/db...</p>';
            try {
                const url = `${window.location.origin}/health/db`;
                const response = await fetch(url);
                const data = await response.json();
                output.innerHTML = `<p class="success">✓ Health endpoint works!</p><div class="code">${JSON.stringify(data, null, 2)}</div>`;
            } catch (e) {
                output.innerHTML = `<p class="error">✗ Error: ${e.message}</p>`;
            }
        }
        
        async function testLoginEndpoint() {
            const output = document.getElementById('apiTest');
            output.innerHTML = '<p>Testing /api/auth/login...</p>';
            try {
                const url = `${window.location.origin}/api/auth/login`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@attendance.com', password: 'password' })
                });
                const data = await response.json();
                output.innerHTML = `<p class="success">✓ Login endpoint works!</p><div class="code">${JSON.stringify(data, null, 2)}</div>`;
            } catch (e) {
                output.innerHTML = `<p class="error">✗ Error: ${e.message}</p>`;
            }
        }
        
        async function testLogoutEndpoint() {
            const output = document.getElementById('apiTest');
            output.innerHTML = '<p>Testing /api/auth/logout...</p>';
            try {
                const url = `${window.location.origin}/api/auth/logout`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                output.innerHTML = `<p class="success">✓ Logout endpoint works!</p><div class="code">${JSON.stringify(data, null, 2)}</div>`;
            } catch (e) {
                output.innerHTML = `<p class="error">✗ Error: ${e.message}</p>`;
            }
        }
        
        // Database data loading tests
        async function testEndpoint(endpoint, buttonName, outputElementId = 'dbTest') {
            const output = document.getElementById(outputElementId);
            const currentHtml = output.innerHTML;
            output.innerHTML += `<p><strong>Testing ${endpoint}...</strong></p>`;
            try {
                const url = `${window.location.origin}${endpoint}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.status === 200 && (data.ok !== false || data.success !== false)) {
                    // Count records
                    let recordCount = 0;
                    if (data.policies) recordCount = data.policies.length;
                    else if (data.users) recordCount = data.users.length;
                    else if (data.modules) recordCount = data.modules.length;
                    else if (data.lecturers) recordCount = data.lecturers.length;
                    else if (data.students) recordCount = data.students.length;
                    else if (data.timetable) recordCount = data.timetable.length;
                    else if (data.classes) recordCount = data.classes.length;
                    else if (data.summary) recordCount = data.summary.length;
                    else if (data.records) recordCount = data.records.length;
                    else if (data.reports) recordCount = data.reports.length;
                    else if (data.stats) recordCount = 1;
                    
                    output.innerHTML += `<p class="success">✓ ${buttonName} - ${recordCount} records returned</p>`;
                } else {
                    output.innerHTML += `<p class="error">✗ ${buttonName} - Error: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (e) {
                output.innerHTML += `<p class="error">✗ ${buttonName} - Error: ${e.message}</p>`;
            }
        }
        
        // System Admin endpoints
        function testPolicies() { testEndpoint('/api/policies', 'Policies'); }
        function testUsers() { testEndpoint('/api/users', 'Users'); }
        
        // Student Service Admin endpoints
        function testModules() { testEndpoint('/api/ssa/modules', 'Modules'); }
        function testLecturers() { testEndpoint('/api/ssa/lecturers', 'Lecturers'); }
        function testStudents() { testEndpoint('/api/ssa/students', 'Students'); }
        function testTimetable() { testEndpoint('/api/ssa/timetable', 'Timetable'); }
        
        // Attendance endpoints
        function testClasses() { testEndpoint('/api/attendance/classes', 'Classes'); }
        function testDailySummary() { testEndpoint('/api/attendance/daily-summary', 'Daily Summary'); }
        
        // Lecturer endpoints
        function testLecturerAttendance() { testEndpoint('/api/lecturer/attendance', 'Lecturer Attendance'); }
        function testLecturerReports() { testEndpoint('/api/lecturer/reports', 'Lecturer Reports'); }
        
        // New comprehensive tests
        function testAlerts() { testEndpoint('/api/alerts', 'System Alerts'); }
        
        async function testDatabaseHealth() {
            const output = document.getElementById('dbHealthTest');
            output.innerHTML = '<p><strong>Testing database connection...</strong></p>';
            try {
                // Test health endpoint
                const healthUrl = `${window.location.origin}/health/db`;
                const healthResponse = await fetch(healthUrl);
                const healthData = await healthResponse.json();
                
                if (healthResponse.status === 200 && healthData.db === 'ok') {
                    output.innerHTML = '<p class="success">✓ Database connection healthy</p>';
                    
                    // Test basic query
                    const modulesUrl = `${window.location.origin}/api/ssa/modules`;
                    const modulesResponse = await fetch(modulesUrl);
                    const modulesData = await modulesResponse.json();
                    
                    if (modulesData.ok && modulesData.modules) {
                        output.innerHTML += `<p class="success">✓ Database queries working - ${modulesData.modules.length} modules found</p>`;
                    }
                } else {
                    output.innerHTML = `<p class="error">✗ Database connection failed: ${JSON.stringify(healthData)}</p>`;
                }
            } catch (e) {
                output.innerHTML = `<p class="error">✗ Database test error: ${e.message}</p>`;
            }
        }
        
        async function testAllEndpoints() {
            const output = document.getElementById('dbTest');
            output.innerHTML = '<h3>Testing All Endpoints:</h3>';
            
            const endpoints = [
                { url: '/api/policies', name: 'Policies', key: 'policies' },
                { url: '/api/users', name: 'Users', key: 'users' },
                { url: '/api/alerts', name: 'Alerts', key: 'alerts' },
                { url: '/api/ssa/modules', name: 'Modules', key: 'modules' },
                { url: '/api/ssa/lecturers', name: 'Lecturers', key: 'lecturers' },
                { url: '/api/ssa/students', name: 'Students', key: 'students' },
                { url: '/api/ssa/timetable', name: 'Timetable', key: 'timetable' },
                { url: '/api/attendance/classes', name: 'Attendance Classes', key: 'classes' },
                { url: '/api/attendance/daily-summary', name: 'Daily Summary', key: 'summary' },
                { url: '/api/lecturer/classes', name: 'Lecturer Classes', key: 'classes' },
                { url: '/api/lecturer/attendance', name: 'Lecturer Attendance', key: 'records' },
                { url: '/api/lecturer/reports', name: 'Lecturer Reports', key: 'reports' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const url = `${window.location.origin}${endpoint.url}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (response.status === 200) {
                        const count = data[endpoint.key] ? data[endpoint.key].length : 0;
                        output.innerHTML += `<p class="success">✓ ${endpoint.name}: ${count} records</p>`;
                    } else {
                        output.innerHTML += `<p class="error">✗ ${endpoint.name}: ${data.error || 'Failed'}</p>`;
                    }
                } catch (e) {
                    output.innerHTML += `<p class="error">✗ ${endpoint.name}: ${e.message}</p>`;
                }
            }
        }
        
        async function testTableCounts() {
            const output = document.getElementById('dbTest');
            output.innerHTML = '<h3>Database Table Row Counts:</h3>';
            output.innerHTML += '<p>Fetching data from all API endpoints...</p>';
            
            try {
                // Fetch from various endpoints to show data availability
                const results = await Promise.all([
                    fetch(`${window.location.origin}/api/ssa/modules`).then(r => r.json()),
                    fetch(`${window.location.origin}/api/ssa/students`).then(r => r.json()),
                    fetch(`${window.location.origin}/api/ssa/lecturers`).then(r => r.json()),
                    fetch(`${window.location.origin}/api/policies`).then(r => r.json()),
                    fetch(`${window.location.origin}/api/attendance/daily-summary`).then(r => r.json())
                ]);
                
                let html = '<div class="code" style="text-align: left;">';
                html += `<strong>Modules:</strong> ${results[0].modules ? results[0].modules.length : 0}<br>`;
                html += `<strong>Students:</strong> ${results[1].students ? results[1].students.length : 0}<br>`;
                html += `<strong>Lecturers:</strong> ${results[2].lecturers ? results[2].lecturers.length : 0}<br>`;
                html += `<strong>Policies:</strong> ${results[3].policies ? results[3].policies.length : 0}<br>`;
                html += `<strong>Attendance Days:</strong> ${results[4].summary ? results[4].summary.length : 0}<br>`;
                html += '</div>';
                
                output.innerHTML = '<h3>Database Summary:</h3>' + html;
                output.innerHTML += '<p class="success">✓ All data queries successful</p>';
            } catch (e) {
                output.innerHTML += `<p class="error">✗ Error fetching counts: ${e.message}</p>`;
            }
        }
        
        // Run tests on page load
        window.addEventListener('DOMContentLoaded', function() {
            testConfig();
            testAuth();
            testSession();
        });
    </script>
</body>
</html>
