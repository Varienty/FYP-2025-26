option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: main:app
  aws:elasticbeanstalk:container:python:staticfiles:
    /static: static/
  
  # Python path configuration
  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: /var/app/current:$PYTHONPATH
    FLASK_ENV: production
    
  # Increase default timeout for long-running requests
  aws:elasticbeanstalk:command:
    Timeout: 600
    
  # Log directory
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

packages:
  yum:
    gcc: []
    python3-devel: []
    mysql: []

commands:
  01_install_dependencies:
    command: |
      source /var/app/venv/*/bin/activate
      pip install --upgrade pip
      pip install -r /var/app/current/requirements.txt
    leader_only: true
    
  02_create_database_schema:
    command: |
      export MYSQL_PWD=$RDS_PASSWORD
      mysql -h $RDS_HOSTNAME -u $RDS_USERNAME -P 3306 --connect-timeout=10 -e "
      USE student_attendance;
      SELECT 1;
      "
    leader_only: true
    ignoreErrors: true

container_commands:
  01_migrate_database:
    command: |
      export MYSQL_PWD=$RDS_PASSWORD
      if ! mysql -h $RDS_HOSTNAME -u $RDS_USERNAME -P 3306 -e "USE student_attendance"; then
        echo "Creating database schema..."
        mysql -h $RDS_HOSTNAME -u $RDS_USERNAME -P 3306 < /var/app/current/sql/schema.sql
      fi
    leader_only: true
