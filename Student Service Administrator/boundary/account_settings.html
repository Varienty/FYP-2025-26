<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - Student Service Administrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../common/config.js"></script>
    <script src="../../common/auth.js"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Account Settings</h1>
            <a href="./dashboard.html" class="bg-gray-700 hover:bg-gray-800 px-4 py-2 rounded-lg">Back to Dashboard</a>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 space-y-6">
            <!-- Change Password Section -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Change Password</h2>
                <form id="changePasswordForm" class="space-y-4">
                    <div>
                        <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                        <input 
                            type="password" 
                            id="currentPassword" 
                            name="currentPassword" 
                            required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                    </div>

                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            name="newPassword" 
                            required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword" 
                            required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                    </div>

                    <div id="passwordMessage" class="hidden p-3 rounded"></div>

                    <button 
                        type="submit" 
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition"
                    >
                        Change Password
                    </button>
                </form>
            </section>

            <hr class="my-6">

            <!-- Account Information Section -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Account Information</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <p id="usernameDisplay" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-800">-</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <p id="emailDisplay" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-800">-</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <p id="roleDisplay" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-800">Student Service Administrator</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Login</label>
                        <p id="lastLoginDisplay" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-800">-</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Check authentication
        requireAuth('student-service-admin');

        // Display user info
        const user = getCurrentUser();
        if (user) {
            document.getElementById('usernameDisplay').textContent = user.username || 'N/A';
            document.getElementById('emailDisplay').textContent = user.email || 'No email set';
            document.getElementById('lastLoginDisplay').textContent = new Date(user.loginTime).toLocaleString();
        }

        // Handle password change
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('passwordMessage');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                messageDiv.classList.remove('hidden', 'bg-green-100', 'border-green-400', 'text-green-700');
                messageDiv.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                messageDiv.textContent = 'New passwords do not match.';
                return;
            }

            // Validate new password length
            if (newPassword.length < 8) {
                messageDiv.classList.remove('hidden', 'bg-green-100', 'border-green-400', 'text-green-700');
                messageDiv.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                messageDiv.textContent = 'New password must be at least 8 characters long.';
                return;
            }

            try {
                const apiBase = window.API_ENDPOINTS?.['student-service-admin'] || 'http://localhost:5008';
                const response = await fetch(apiBase + '/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: user.username,
                        currentPassword,
                        newPassword
                    })
                });

                const data = await response.json();
                messageDiv.classList.remove('hidden');

                if (data.ok) {
                    messageDiv.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
                    messageDiv.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                    messageDiv.textContent = 'Password changed successfully!';
                    document.getElementById('changePasswordForm').reset();
                } else {
                    messageDiv.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                    messageDiv.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                    messageDiv.textContent = data.message || 'Failed to change password.';
                }
            } catch (e) {
                console.error('Error changing password:', e);
                messageDiv.classList.remove('hidden', 'bg-green-100', 'border-green-400', 'text-green-700');
                messageDiv.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                messageDiv.textContent = 'Failed to change password: ' + e.message;
            }
        });
    </script>
</body>
</html>
