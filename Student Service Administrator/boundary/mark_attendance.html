<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - Student Service Administrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../common/config.js"></script>
    <script src="../../common/auth.js"></script>
    <style>
        .attendance-cell {
            min-width: 140px;
            text-align: center;
            padding: 8px 4px !important;
        }

        .attendance-status-btn {
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            display: block;
            width: 100%;
            border: 2px solid transparent;
            user-select: none;
        }

        .attendance-status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }

        .attendance-status-btn:active {
            transform: translateY(0);
        }

        .status-present {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }
        .status-absent {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }
        .status-late {
            background-color: #fed7aa;
            color: #92400e;
            border-color: #f59e0b;
        }
        .status-unmarked {
            background-color: #f3f4f6;
            color: #6b7280;
            border: 2px dashed #d1d5db;
        }
        .status-unmarked:hover {
            background-color: #e5e7eb;
            border-style: solid;
        }
        .status-mc {
            background-color: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }

        .session-header {
            writing-mode: horizontal-tb;
            min-width: 140px;
            text-align: center;
            font-size: 12px;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sticky-col:nth-child(2) {
            left: 120px;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 20;
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .modified {
            animation: pulse-ring 1.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation Bar -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Mark Attendance</h1>
            <div class="flex items-center space-x-4">
                <a href="./dashboard.html" class="bg-gray-700 hover:bg-gray-800 px-4 py-2 rounded-lg transition">Back to Dashboard</a>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">Logout</button>
            </div>
        </div>
    </nav>

    <div class="max-w-full mx-auto px-4 py-6">
        <!-- Header Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Mark Attendance by Session</h2>

            <!-- Module Selection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Class/Module</label>
                    <select id="moduleSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">-- Select Module --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <div class="flex space-x-2">
                        <input type="date" id="startDate" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <span class="flex items-center">to</span>
                        <input type="date" id="endDate" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <button id="loadSessionsBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition">
                Load Sessions & Students
            </button>
        </div>

        <!-- Message -->
        <div id="message" class="hidden p-4 rounded-lg mb-6"></div>

        <!-- Main Content Grid -->
        <div id="mainContent" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Attendance Grid (2/3 width) -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Student Attendance Grid</h3>
                    <div class="flex space-x-2">
                        <button id="saveAllBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm">
                            üíæ Save All
                        </button>
                        <button id="refreshBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                <!-- Instructions & Legend -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-semibold text-blue-900 text-sm">How to use: Click any cell to mark attendance for that student in that lesson</span>
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs">
                        <span class="px-3 py-1 rounded status-present font-semibold">‚úì Present</span>
                        <span class="px-3 py-1 rounded status-absent font-semibold">‚úó Absent</span>
                        <span class="px-3 py-1 rounded status-late font-semibold">üïê Late</span>
                        <span class="px-3 py-1 rounded status-mc font-semibold">üè• MC</span>
                        <span class="px-3 py-1 rounded status-unmarked font-semibold">‚Äî Unmarked</span>
                        <span class="text-gray-600 ml-2">‚Üê Click cells to cycle through statuses</span>
                    </div>
                </div>

                <!-- Attendance Table -->
                <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="sticky-header">
                            <tr class="bg-gray-100" id="headerRow">
                                <th class="sticky-col px-4 py-3 border border-gray-300 text-left">Student ID</th>
                                <th class="sticky-col px-4 py-3 border border-gray-300 text-left" style="left: 120px;">Name</th>
                                <!-- Session headers will be added here dynamically -->
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Medical Certificates Panel (1/3 width) -->
            <div class="lg:col-span-1 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üè• Pending Medical Certificates</h3>

                <div id="mcList" class="space-y-4">
                    <!-- Will be populated dynamically -->
                </div>

                <div id="noMcMessage" class="hidden text-center text-gray-500 py-8">
                    <svg class="w-16 h-16 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>No pending MCs</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MC View Modal -->
    <div id="mcModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Medical Certificate Details</h3>
                    <button id="closeMcModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div id="mcModalContent">
                    <!-- Will be populated dynamically -->
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="rejectMcBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition">
                        Reject
                    </button>
                    <button id="approveMcBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition">
                        Approve & Mark Excused
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        requireAuth('student-service-admin');

        const API_BASE = window.API_ENDPOINTS?.['student-service-admin'] || 'http://localhost:5008';

        let currentModuleId = null;
        let sessions = [];
        let students = [];
        let attendanceData = {};
        let currentMcId = null;

        // Initialize date inputs: first day of current month to last day of next month
        const today = new Date();

        // First day of current month
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

        // Last day of next month
        const lastDayOfNextMonth = new Date(today.getFullYear(), today.getMonth() + 2, 0);

        document.getElementById('startDate').valueAsDate = firstDayOfMonth;
        document.getElementById('endDate').valueAsDate = lastDayOfNextMonth;

        // Load modules
        async function loadModules() {
            try {
                const response = await fetch(`${API_BASE}/api/attendance/classes`);
                const data = await response.json();

                const select = document.getElementById('moduleSelect');
                select.innerHTML = '<option value="">-- Select Module --</option>';

                if (data.ok && data.classes) {
                    data.classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = cls.fullName;
                        option.dataset.code = cls.code;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading modules:', error);
                showMessage('Failed to load modules', 'error');
            }
        }

        // Load sessions and students
        document.getElementById('loadSessionsBtn').addEventListener('click', async () => {
            currentModuleId = document.getElementById('moduleSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!currentModuleId) {
                showMessage('Please select a module', 'error');
                return;
            }

            if (!startDate || !endDate) {
                showMessage('Please select date range', 'error');
                return;
            }

            try {
                showMessage('Loading sessions and students...', 'info');

                // Load sessions for module
                const sessionsResponse = await fetch(
                    `${API_BASE}/api/attendance/sessions?moduleId=${currentModuleId}&startDate=${startDate}&endDate=${endDate}`
                );
                const sessionsData = await sessionsResponse.json();

                // Load enrolled students
                const studentsResponse = await fetch(
                    `${API_BASE}/api/attendance/students?moduleId=${currentModuleId}`
                );
                const studentsData = await studentsResponse.json();

                // Load existing attendance records
                const attendanceResponse = await fetch(
                    `${API_BASE}/api/attendance/records?moduleId=${currentModuleId}&startDate=${startDate}&endDate=${endDate}`
                );
                const attendanceDataResponse = await attendanceResponse.json();

                if (sessionsData.ok && studentsData.ok) {
                    sessions = sessionsData.sessions || [];
                    students = studentsData.students || [];
                    attendanceData = attendanceDataResponse.records || {};

                    console.log('Loaded data:', {
                        sessionsCount: sessions.length,
                        studentsCount: students.length,
                        attendanceRecordsCount: Object.keys(attendanceData).length,
                        sampleSession: sessions[0],
                        sampleStudent: students[0],
                        sampleAttendanceKeys: Object.keys(attendanceData).slice(0, 5)
                    });

                    displayAttendanceGrid();
                    loadPendingMCs();

                    document.getElementById('mainContent').classList.remove('hidden');

                    const recordCount = Object.keys(attendanceData).length;
                    showMessage(`Loaded ${sessions.length} sessions, ${students.length} students, and ${recordCount} existing attendance records`, 'success');
                } else {
                    showMessage('Failed to load data', 'error');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Failed to load data: ' + error.message, 'error');
            }
        });

        // Display attendance grid
        function displayAttendanceGrid() {
            const headerRow = document.getElementById('headerRow');
            const tbody = document.getElementById('attendanceTableBody');

            // Clear existing session headers (keep Student ID and Name headers)
            while (headerRow.children.length > 2) {
                headerRow.removeChild(headerRow.lastChild);
            }
            tbody.innerHTML = '';

            // Create session headers
            sessions.forEach(session => {
                const th = document.createElement('th');
                th.className = 'session-header px-2 py-3 border border-gray-300 text-xs';
                th.innerHTML = `
                    <div class="font-semibold">${formatDate(session.date)}</div>
                    <div class="text-gray-500 font-normal">${session.startTime} - ${session.endTime}</div>
                    <div class="text-gray-400 font-normal">${session.room || 'TBA'}</div>
                `;
                headerRow.appendChild(th);
            });

            // Create student rows
            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                // Student ID (sticky)
                const tdId = document.createElement('td');
                tdId.className = 'sticky-col px-4 py-2 border border-gray-300 text-sm font-medium';
                tdId.textContent = student.studentId;
                tr.appendChild(tdId);

                // Student Name (sticky)
                const tdName = document.createElement('td');
                tdName.className = 'sticky-col px-4 py-2 border border-gray-300 text-sm';
                tdName.style.left = '120px';
                tdName.textContent = student.name;
                tr.appendChild(tdName);

                // Attendance cells for each session
                sessions.forEach((session, idx) => {
                    const td = document.createElement('td');
                    td.className = 'attendance-cell border border-gray-300';

                    const key = `${student.id}_${session.id}`;
                    const currentStatus = attendanceData[key]?.status || 'unmarked';
                    const hasMc = attendanceData[key]?.hasMc || false;

                    // Debug first student's first cell
                    if (student.id === students[0].id && idx === 0) {
                        console.log('First cell debug:', {
                            key,
                            found: !!attendanceData[key],
                            status: currentStatus,
                            hasMc,
                            availableKeys: Object.keys(attendanceData).filter(k => k.startsWith(`${student.id}_`)).slice(0, 3)
                        });
                    }

                    td.innerHTML = `
                        <div class="attendance-status-btn status-${hasMc ? 'mc' : currentStatus}"
                             data-student-id="${student.id}"
                             data-session-id="${session.id}"
                             data-status="${currentStatus}"
                             onclick="toggleStatus(this)"
                             title="Click to mark attendance">
                            ${hasMc ? 'üè• MC' : getStatusLabel(currentStatus)}
                        </div>
                    `;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // Toggle attendance status
        window.toggleStatus = function(element) {
            const currentStatus = element.dataset.status;
            const statuses = ['unmarked', 'present', 'absent', 'late'];
            const currentIndex = statuses.indexOf(currentStatus);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];

            element.dataset.status = nextStatus;
            element.className = `attendance-status-btn status-${nextStatus} modified`;
            element.textContent = getStatusLabel(nextStatus);

            // Add visual feedback
            setTimeout(() => {
                element.classList.remove('modified');
            }, 1500);
        };

        // Get status label
        function getStatusLabel(status) {
            const labels = {
                present: '‚úì Present',
                absent: '‚úó Absent',
                late: 'üïê Late',
                unmarked: '‚Äî',
                mc: 'üè• MC'
            };
            return labels[status] || '‚Äî';
        }

        // Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { month: 'short', day: 'numeric', weekday: 'short' };
            return date.toLocaleDateString('en-US', options);
        }

        // Save all attendance
        document.getElementById('saveAllBtn').addEventListener('click', async () => {
            const records = [];

            document.querySelectorAll('.attendance-status-btn').forEach(cell => {
                const studentId = cell.dataset.studentId;
                const sessionId = cell.dataset.sessionId;
                const status = cell.dataset.status;

                if (status !== 'unmarked') {
                    records.push({
                        studentId,
                        sessionId,
                        moduleId: currentModuleId,
                        status,
                        checkInTime: new Date().toISOString()
                    });
                }
            });

            try {
                // Get admin info from session storage
                const authUser = sessionStorage.getItem('auth_user');
                let adminInfo = {
                    id: 1,
                    name: 'Student Service Admin',
                    email: 'admin@school.edu'
                };

                // Try to parse stored auth info
                try {
                    if (authUser) {
                        const user = JSON.parse(authUser);
                        // Construct full name from firstName and lastName
                        const fullName = user.firstName && user.lastName
                            ? `${user.firstName} ${user.lastName}`
                            : user.username || 'Student Service Admin';

                        adminInfo = {
                            id: user.id || 1,
                            name: fullName,
                            email: user.email || 'admin@school.edu'
                        };
                    }
                } catch (e) {
                    console.log('Using default admin info');
                }

                const response = await fetch(`${API_BASE}/api/attendance/mark-bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ records, adminInfo })
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage(`Saved ${records.length} attendance records`, 'success');
                    // Remove modified indicators
                    document.querySelectorAll('.attendance-status-btn').forEach(cell => {
                        cell.classList.remove('modified');
                    });
                } else {
                    showMessage('Failed to save attendance', 'error');
                }
            } catch (error) {
                console.error('Error saving attendance:', error);
                showMessage('Failed to save attendance: ' + error.message, 'error');
            }
        });

        // Refresh data
        document.getElementById('refreshBtn').addEventListener('click', () => {
            document.getElementById('loadSessionsBtn').click();
        });

        // Load pending MCs
        async function loadPendingMCs() {
            try {
                const response = await fetch(
                    `${API_BASE}/api/attendance/medical-certificates?moduleId=${currentModuleId}&status=pending`
                );
                const data = await response.json();

                const mcList = document.getElementById('mcList');
                const noMcMessage = document.getElementById('noMcMessage');

                mcList.innerHTML = '';

                if (data.ok && data.certificates && data.certificates.length > 0) {
                    noMcMessage.classList.add('hidden');
                    mcList.classList.remove('hidden');

                    data.certificates.forEach(mc => {
                        const mcCard = document.createElement('div');
                        mcCard.className = 'border border-blue-200 rounded-lg p-4 bg-blue-50 hover:bg-blue-100 transition cursor-pointer';
                        mcCard.onclick = () => viewMC(mc);
                        mcCard.innerHTML = `
                            <div class="flex items-start justify-between mb-2">
                                <div class="font-semibold text-sm">${mc.studentName}</div>
                                <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded">Pending</span>
                            </div>
                            <div class="text-xs text-gray-600">
                                <div>ID: ${mc.studentId}</div>
                                <div>Dates: ${formatDate(mc.startDate)} - ${formatDate(mc.endDate)}</div>
                                <div>Reason: ${mc.reason}</div>
                                <div class="mt-2 text-blue-600 font-medium">Click to review ‚Üí</div>
                            </div>
                        `;
                        mcList.appendChild(mcCard);
                    });
                } else {
                    noMcMessage.classList.remove('hidden');
                    mcList.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading MCs:', error);
            }
        }

        // View MC details
        function viewMC(mc) {
            currentMcId = mc.id;
            const modal = document.getElementById('mcModal');
            const content = document.getElementById('mcModalContent');

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Student ID</label>
                            <div class="text-gray-900">${mc.studentId}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Student Name</label>
                            <div class="text-gray-900">${mc.studentName}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Start Date</label>
                            <div class="text-gray-900">${formatDate(mc.startDate)}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">End Date</label>
                            <div class="text-gray-900">${formatDate(mc.endDate)}</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                        <div class="text-gray-900 bg-gray-50 p-3 rounded">${mc.reason}</div>
                    </div>
                    ${mc.certificateFile ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Certificate Document</label>
                            <div class="border-2 border-gray-200 rounded-lg p-4 bg-gray-50">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <svg class="w-8 h-8 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <div>
                                            <div class="text-sm font-semibold text-gray-800">Medical Certificate</div>
                                            <div class="text-xs text-gray-500">${mc.certificateFile.split('/').pop()}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <a href="/Student/backend/${mc.certificateFile}"
                                       target="_blank"
                                       class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-center py-2 px-4 rounded-lg transition font-semibold text-sm">
                                        <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        View Document
                                    </a>
                                    <a href="/Student/backend/${mc.certificateFile}"
                                       download
                                       class="flex-1 bg-green-500 hover:bg-green-600 text-white text-center py-2 px-4 rounded-lg transition font-semibold text-sm">
                                        <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        Download
                                    </a>
                                </div>
                                <img src="/Student/backend/${mc.certificateFile}"
                                     class="w-full border rounded-lg mt-3 cursor-pointer hover:opacity-90 transition"
                                     alt="MC Certificate Preview"
                                     onclick="window.open('/Student/backend/${mc.certificateFile}', '_blank')"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                     style="max-height: 400px; object-fit: contain;">
                                <div style="display:none;" class="text-center text-gray-500 text-sm mt-3 p-4 bg-gray-100 rounded">
                                    Preview not available. Click "View Document" to open the file.
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-gray-500 text-sm">No certificate uploaded</p>
                        </div>
                    `}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Uploaded At</label>
                        <div class="text-gray-600 text-sm">${new Date(mc.uploadedAt).toLocaleString()}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Review Notes</label>
                        <textarea id="reviewNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder="Add notes about this MC (optional)"></textarea>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close modal
        document.getElementById('closeMcModal').addEventListener('click', () => {
            document.getElementById('mcModal').classList.add('hidden');
        });

        // Approve MC
        document.getElementById('approveMcBtn').addEventListener('click', async () => {
            if (!currentMcId) return;

            const notes = document.getElementById('reviewNotes').value;

            try {
                const response = await fetch(`${API_BASE}/api/attendance/medical-certificates/${currentMcId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('MC approved successfully', 'success');
                    document.getElementById('mcModal').classList.add('hidden');
                    loadPendingMCs();
                    // Refresh attendance grid
                    document.getElementById('loadSessionsBtn').click();
                } else {
                    showMessage('Failed to approve MC', 'error');
                }
            } catch (error) {
                console.error('Error approving MC:', error);
                showMessage('Failed to approve MC: ' + error.message, 'error');
            }
        });

        // Reject MC
        document.getElementById('rejectMcBtn').addEventListener('click', async () => {
            if (!currentMcId) return;

            const notes = document.getElementById('reviewNotes').value;

            if (!confirm('Are you sure you want to reject this MC?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/attendance/medical-certificates/${currentMcId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('MC rejected', 'success');
                    document.getElementById('mcModal').classList.add('hidden');
                    loadPendingMCs();
                } else {
                    showMessage('Failed to reject MC', 'error');
                }
            } catch (error) {
                console.error('Error rejecting MC:', error);
                showMessage('Failed to reject MC: ' + error.message, 'error');
            }
        });

        // Show message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.classList.remove('hidden', 'bg-green-100', 'border-green-400', 'text-green-700',
                                       'bg-red-100', 'border-red-400', 'text-red-700',
                                       'bg-blue-100', 'border-blue-400', 'text-blue-700');

            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
            } else {
                messageDiv.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
            }

            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            logout();
        });

        // Initialize
        loadModules();
    </script>
</body>
</html>
